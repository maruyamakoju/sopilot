# SOPilot Issue Tracker

Remaining refactoring and improvement items, prioritized by impact.

---

## P0 - High Priority (Security / Stability)

### [P0-1] Add tests for `audit_service.py`
Compliance/security auditing code has no dedicated test file. Audit trail integrity and signed export verification need coverage.

### [P0-2] Add tests for `db.py`
Database layer (SQLite operations, schema migrations, `_ensure_column`, job state machine) has no dedicated tests. Currently only exercised indirectly via integration tests.

### [P0-3] Add tests for `dtw_gpu.py`
GPU DTW acceleration wrapper (CuPy) has no tests. Needs at least a CPU-fallback path test to verify graceful degradation.

---

## P1 - Medium Priority (Core Functionality)

### [P1-1] Add tests for `embeddings.py`
Embedding pipeline (VJepa2Embedder, HeuristicEmbedder, AutoEmbedder) untested in isolation. Currently only exercised via E2E API tests.

### [P1-2] Add tests for `worker_tasks.py`
Worker task dispatching module untested. Verify correct routing of ingest/score/training jobs.

### [P1-3] Comprehensive API endpoint tests
`test_api_async_training.py` covers the happy path; `test_api_auth_rbac.py` covers auth. Missing: error edge cases, pagination, input validation for all endpoints.

### [P1-4] Add tests for `storage.py`
Directory structure management (`ensure_directories`) untested.

### ~~[P1-5] Add tests for `nn/functional.py`~~ ✅ DONE (2026-02-12)
Added `tests/test_nn_functional_unit.py` with 19 tests covering softmin3, pairwise_euclidean_sq, pairwise_cosine_dist.

---

## P2 - Low Priority (Hardening)

### [P2-1] Add tests for `adapt/train_domain_adapter.py`
Domain adaptation training pipeline untested.

### ~~[P2-2] Add tests for `nn/constants.py`~~ ✅ DONE (2026-02-12)
Added `tests/test_nn_constants_unit.py` with 3 tests.

### [P2-3] Add tests for `logging_config.py`
Structured logging setup and `LogContext` context manager untested.

### [P2-4] Add tests for `metrics.py`
Prometheus metrics collection (`track_job_duration`, `collect_gpu_metrics`) untested.

### [P2-5] Add tests for `main.py`
Entry point module untested. Verify `create_app()` wiring and `run()` function.

---

## P3 - Tech Debt / Nice-to-Have

### [P3-1] Pin exact CI dependency versions
Currently using `>=` minimum bounds. Consider adding a `requirements-lock.txt` or using `pip-compile` for reproducible CI builds.

### [P3-2] Add pre-commit hooks
Configure pre-commit with ruff check + ruff format for automatic linting on commit.

### [P3-3] Add type checking
Consider adding `mypy` or `pyright` to CI. The 6 `# type: ignore` comments are all justified (optional dependency guards).

### [P3-4] Coverage reporting
Add `pytest-cov` to CI with a minimum coverage threshold.

### [P3-5] Docker / container support
Add a `Dockerfile` and `docker-compose.yml` for local dev and production deployment (API + Redis + Worker).

### [P3-6] API documentation
OpenAPI spec is auto-generated by FastAPI. Consider adding example request/response payloads and a deployment guide.

---

## Completed (2026-02-11 Refactoring)

- [x] Wave 1: Dead code removal, double `_now()` bug fix, `NeuralModelCache`, `evaluate_sop()` decomposition, `make_test_settings()` fixture, generalized DB job helpers
- [x] Wave 2: `nn/functional.py` extraction, DDL injection prevention, soft_dtw input validation, NaN threshold fix (50% -> 20%), cost matrix deduplication
- [x] Wave 3: `nn/constants.py` (GAMMA_MIN, INF), registry-based neural model loader, V-JEPA2 retry on transient errors, AutoEmbedder periodic re-probe
- [x] Git init + initial commit + `baseline-refactor` tag
- [x] E2E smoke test (`scripts/smoke_e2e.py`) - 13 checks
- [x] CI setup (lint + test + smoke jobs)
- [x] Ruff lint/format pass (134 auto-fixed, 48 reformatted)
- [x] Dependency audit (added ruff to dev deps)

## Completed (2026-02-12 Priority 5 + Refactoring)

- [x] Priority 5: 2-Stage Event Detection (`event_detection_service.py`, `event_detection_demo.py`, 22 tests)
- [x] Extracted `temporal.py`: shared `temporal_iou()` (eliminated 3x duplication across rag_service, event_detection, vigil_metrics)
- [x] Extracted `llm_utils.py`: shared `parse_llm_json()` (eliminated 2x duplication across rag_service, event_detection)
- [x] Unified `compute_video_checksum` → delegates to `rag_service.compute_video_id` (eliminated SHA-256 reimplementation)
- [x] Centralized mock VIGIL services: `make_mock_vigil_services()` in conftest.py (deduped test_rag + test_event_detection)
- [x] Fixed `evaluation/__init__.py`: exports vigil_metrics (EvidenceRecallResult, EventDetectionResult, etc.)
- [x] Simplified `chunking_result_to_clip_records`: 4 loops → `itertools.chain` one-liner
- [x] Extracted `index_video_micro()` into vigil_helpers.py (deduped smoke_e2e + event_detection_demo)
- [x] Added `tests/test_nn_functional_unit.py` (19 tests) — closes P1-5
- [x] Added `tests/test_nn_constants_unit.py` (3 tests) — closes P2-2
- [x] Full lint pass: 46 ruff errors → 0 (import sorting, unused imports, B905 strict=, F821, B007)
- [x] Full test suite: 600 tests passing
