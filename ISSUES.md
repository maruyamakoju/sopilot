# SOPilot Issue Tracker

Remaining refactoring and improvement items, prioritized by impact.

---

## P0 - High Priority (Security / Stability)

### ~~[P0-1] Add tests for `audit_service.py`~~ ✅ DONE (2026-02-12)
Added `tests/test_audit_service.py` (19 tests): audit trail, HMAC-SHA256 signed export, signature roundtrip, path sanitization.

### ~~[P0-2] Add tests for `db.py`~~ ✅ DONE (2026-02-12)
Added `tests/test_db.py` (46 tests): schema init, _ensure_column guards, video CRUD, clips, job lifecycles, audit queries.

### ~~[P0-3] Add tests for `dtw_gpu.py`~~ ✅ DONE (2026-02-12)
Added `tests/test_dtw_gpu.py` (13 tests): DtwAlignment, CPU fallback, auto-routing, GPU availability, diagnostics.

---

## P1 - Medium Priority (Core Functionality)

### ~~[P1-1] Add tests for `embeddings.py`~~ ✅ DONE (2026-02-13)
Added `tests/test_embeddings.py` (47 tests): HeuristicClipEmbedder feature extraction, VJepa2Embedder temporal sampling/pooling/error paths, AutoEmbedder fallback/recovery, build_embedder factory.

### ~~[P1-2] Add tests for `worker_tasks.py`~~ ✅ DONE (2026-02-13)
Added `tests/test_worker_tasks.py` (10 tests): singleton init, job delegation, shutdown idempotency, error propagation.

### ~~[P1-3] Comprehensive API endpoint tests~~ ✅ DONE (2026-02-13)
Added `tests/test_api_edge_cases.py` (45 tests): role/auth helpers, search endpoint validation, query param boundaries, 404 paths, metrics endpoint.

### ~~[P1-4] Add tests for `storage.py`~~ ✅ DONE (2026-02-13)
Added `tests/test_storage.py` (5 tests): ensure_directories creation, idempotency, nested paths.

### ~~[P1-5] Add tests for `nn/functional.py`~~ ✅ DONE (2026-02-12)
Added `tests/test_nn_functional_unit.py` with 19 tests covering softmin3, pairwise_euclidean_sq, pairwise_cosine_dist.

---

## P2 - Low Priority (Hardening)

### [P2-1] Add tests for `adapt/train_domain_adapter.py`
Domain adaptation training pipeline untested.

### ~~[P2-2] Add tests for `nn/constants.py`~~ ✅ DONE (2026-02-12)
Added `tests/test_nn_constants_unit.py` with 3 tests.

### [P2-3] Add tests for `logging_config.py`
Structured logging setup and `LogContext` context manager untested.

### [P2-4] Add tests for `metrics.py`
Prometheus metrics collection (`track_job_duration`, `collect_gpu_metrics`) untested.

### [P2-5] Add tests for `main.py`
Entry point module untested. Verify `create_app()` wiring and `run()` function.

---

## P3 - Tech Debt / Nice-to-Have

### [P3-1] Pin exact CI dependency versions
Currently using `>=` minimum bounds. Consider adding a `requirements-lock.txt` or using `pip-compile` for reproducible CI builds.

### [P3-2] Add pre-commit hooks
Configure pre-commit with ruff check + ruff format for automatic linting on commit.

### [P3-3] Add type checking
Consider adding `mypy` or `pyright` to CI. The 6 `# type: ignore` comments are all justified (optional dependency guards).

### [P3-4] Coverage reporting
Add `pytest-cov` to CI with a minimum coverage threshold.

### ~~[P3-5] Docker / container support~~ ✅ DONE (2026-02-13)
Multi-stage Dockerfile (root=CPU-only, docker/Dockerfile.cpu=with PyTorch, docker/Dockerfile.gpu=CUDA 12.1). docker-compose.yml with API+worker+redis+qdrant+postgres. .env.example with all vars.

### [P3-6] API documentation
OpenAPI spec is auto-generated by FastAPI. Consider adding example request/response payloads and a deployment guide.

---

## Completed (2026-02-11 Refactoring)

- [x] Wave 1: Dead code removal, double `_now()` bug fix, `NeuralModelCache`, `evaluate_sop()` decomposition, `make_test_settings()` fixture, generalized DB job helpers
- [x] Wave 2: `nn/functional.py` extraction, DDL injection prevention, soft_dtw input validation, NaN threshold fix (50% -> 20%), cost matrix deduplication
- [x] Wave 3: `nn/constants.py` (GAMMA_MIN, INF), registry-based neural model loader, V-JEPA2 retry on transient errors, AutoEmbedder periodic re-probe
- [x] Git init + initial commit + `baseline-refactor` tag
- [x] E2E smoke test (`scripts/smoke_e2e.py`) - 13 checks
- [x] CI setup (lint + test + smoke jobs)
- [x] Ruff lint/format pass (134 auto-fixed, 48 reformatted)
- [x] Dependency audit (added ruff to dev deps)

## Completed (2026-02-12 Priority 5 + Refactoring)

- [x] Priority 5: 2-Stage Event Detection (`event_detection_service.py`, `event_detection_demo.py`, 22 tests)
- [x] Extracted `temporal.py`: shared `temporal_iou()` (eliminated 3x duplication across rag_service, event_detection, vigil_metrics)
- [x] Extracted `llm_utils.py`: shared `parse_llm_json()` (eliminated 2x duplication across rag_service, event_detection)
- [x] Unified `compute_video_checksum` → delegates to `rag_service.compute_video_id` (eliminated SHA-256 reimplementation)
- [x] Centralized mock VIGIL services: `make_mock_vigil_services()` in conftest.py (deduped test_rag + test_event_detection)
- [x] Fixed `evaluation/__init__.py`: exports vigil_metrics (EvidenceRecallResult, EventDetectionResult, etc.)
- [x] Simplified `chunking_result_to_clip_records`: 4 loops → `itertools.chain` one-liner
- [x] Extracted `index_video_micro()` into vigil_helpers.py (deduped smoke_e2e + event_detection_demo)
- [x] Added `tests/test_nn_functional_unit.py` (19 tests) — closes P1-5
- [x] Added `tests/test_nn_constants_unit.py` (3 tests) — closes P2-2
- [x] Full lint pass: 46 ruff errors → 0 (import sorting, unused imports, B905 strict=, F821, B007)
- [x] Full test suite: 600 tests passing
